<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sector-7 | DDOS Protection</title>
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body id="turnstile-page">
  <h1>Sector-7 | DDOS Protection</h1>
  <form id="turnstile-form" onsubmit="return false;">
    <p>Complete the CAPTCHA to proceed to Sector-7:</p>
    <div id="turnstile-widget-container" class="cf-turnstile"
         data-sitekey="0x4AAAAAABBp8DDATkRt9PbP"
         data-callback="onTurnstileSuccess"
         data-error-callback="onTurnstileError"
         data-expired-callback="onTurnstileExpired">
    </div>
    <button type="button" id="captcha-submit-button" disabled>Verifying...</button>
    <p id="turnstile-message" style="margin-top: 10px; min-height: 1.2em;"></p>
  </form>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
    let currentTurnstileToken = null;
    const submitButton = document.getElementById('captcha-submit-button');
    const turnstileMessage = document.getElementById('turnstile-message');

    function enableSubmitButton(enable = true, message = "Proceed to Site") {
      submitButton.disabled = !enable;
      submitButton.textContent = message;
    }

    function setTurnstileMessage(message, isError = false) {
      turnstileMessage.textContent = message;
      turnstileMessage.style.color = isError ? 'red' : 'limegreen';
    }

    function getUserLangPath() {
      const langCode = navigator.language.split('-')[0]; // e.g., "en", "es"
      const supported = ['en', 'es', 'fr', 'de', 'zh']; // add more supported languages here
      const fallback = 'en';
      return supported.includes(langCode) ? langCode : fallback;
    }

    async function onTurnstileSuccess(token) {
      currentTurnstileToken = token;
      enableSubmitButton(true, "Verifying...");
      setTurnstileMessage("CAPTCHA passed. Verifying...");

      try {
        const response = await fetch('https://sector7-turnstile-verifier.wampired2.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ "cf-turnstile-response": currentTurnstileToken })
        });

        const result = await response.json();

        if (result.success) {
          setTurnstileMessage("Verification successful! Redirecting...");
          enableSubmitButton(false, "Redirecting...");
          const lang = getUserLangPath();
          window.location.href = `/${lang}/home.html`;
        } else {
          setTurnstileMessage("CAPTCHA verification failed. Try again.", true);
          console.error('Turnstile failed:', result.errors);
          enableSubmitButton(true, "Retry");
          resetTurnstileWidget();
        }
      } catch (error) {
        setTurnstileMessage("Error verifying CAPTCHA.", true);
        console.error('Verification error:', error);
        enableSubmitButton(true, "Retry");
        resetTurnstileWidget();
      }
    }

    function onTurnstileError(errCode) {
      currentTurnstileToken = null;
      setTurnstileMessage(`CAPTCHA error (${errCode}).`, true);
      enableSubmitButton(false, "Error");
    }

    function onTurnstileExpired() {
      currentTurnstileToken = null;
      setTurnstileMessage("CAPTCHA expired. Try again.", true);
      enableSubmitButton(false, "Expired");
      resetTurnstileWidget();
    }

    function resetTurnstileWidget() {
      if (typeof turnstile !== 'undefined') {
        turnstile.reset('#turnstile-widget-container');
        enableSubmitButton(false, "Verifying...");
      }
    }

    submitButton.addEventListener('click', () => {
      if (!submitButton.disabled && currentTurnstileToken) {
        onTurnstileSuccess(currentTurnstileToken);
      }
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker registered'))
        .catch(e => console.error('SW registration failed:', e));
    }
  </script>
</body>
</html>
